local shovels = {
    [19514] = { -- Wooden Shovel
        dig_time = 4,  -- Digging time in seconds
        uses = 5,  -- Number of uses
    	possible_items = {
        {itemid = 19488, count = 1, chance = 0.1},  -- 10% Bronze Chest 
        {itemid = 19489, count = 1, chance = 0.1},  -- 10% Silver Chest 
        {itemid = 19490, count = 1, chance = 0.05},  -- 5% Gold Chest 
        {itemid = 19491, count = 1, chance = 0.05},  -- 5% Platinum Chest 
        {itemid = 19492, count = 1, chance = 0.04},  -- 4% Diamond Chest 
        {itemid = 19500, count = 1, chance = 0.02},  -- 2% Emerald Chest 
        {itemid = 19501, count = 1, chance = 0.01},  -- 1% Ametrhyst Chest 
        {itemid = 19482, count = 1, chance = 0.1},  -- 10% Black pear
        {itemid = 19483, count = 1, chance = 0.08},  -- 8% Blue Pearl 
        {itemid = 19484, count = 1, chance = 0.07},  -- 7% Purple Pearl
        {itemid = 19485, count = 1, chance = 0.06},  -- 6% Red pearl
        {itemid = 19486, count = 1, chance = 0.05},  -- 5% Golden pearl
        {itemid = 19510, count = 1, chance = 0.1},  -- 10% Bronze Ore
        {itemid = 19517, count = 1, chance = 0.09},  -- 9% Silver Ore
        {itemid = 19518, count = 1, chance = 0.08},  -- 8% Gold Ore
        {itemid = 19519, count = 1, chance = 0.07},  -- 7% Platinum Ore
        {itemid = 16857, count = 2, chance = 0.3},  -- 30% Dragon Soul 
        {itemid = 12765, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12766, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12767, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12768, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12769, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12770, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12771, count = 1, chance = 0.007}  -- 0.7% Dragon Ball 

        

    }
    },
    [19521] = { -- Metal Shovel
        dig_time = 3,
        uses = 20,
    	possible_items = {
        {itemid = 19488, count = 1, chance = 0.1},  -- 10% Bronze Chest 
        {itemid = 19489, count = 1, chance = 0.1},  -- 10% Silver Chest 
        {itemid = 19490, count = 1, chance = 0.05},  -- 5% Gold Chest 
        {itemid = 19491, count = 1, chance = 0.05},  -- 5% Platinum Chest 
        {itemid = 19492, count = 1, chance = 0.04},  -- 4% Diamond Chest 
        {itemid = 19500, count = 1, chance = 0.02},  -- 2% Emerald Chest 
        {itemid = 19501, count = 1, chance = 0.01},  -- 1% Ametrhyst Chest 
        {itemid = 19482, count = 1, chance = 0.1},  -- 10% Black pear
        {itemid = 19483, count = 1, chance = 0.08},  -- 8% Blue Pearl 
        {itemid = 19484, count = 1, chance = 0.07},  -- 7% Purple Pearl
        {itemid = 19485, count = 1, chance = 0.06}, -- 6% Red pearl
        {itemid = 19486, count = 1, chance = 0.05},  -- 5% Golden pearl
        {itemid = 19510, count = 1, chance = 0.1},  -- 10% Bronze Ore
        {itemid = 19517, count = 1, chance = 0.09},  -- 9% Silver Ore
        {itemid = 19518, count = 1, chance = 0.08},  -- 8% Gold Ore
        {itemid = 19519, count = 1, chance = 0.07},  -- 7% Platinum Ore
        {itemid = 16857, count = 2, chance = 0.3},  -- 30% Dragon Soul 
        {itemid = 12765, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12766, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12767, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12768, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12769, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12770, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12771, count = 1, chance = 0.007}  -- 0.7% Dragon Ball 
    }
    },
    [19515] = { -- Metal Shovel
        dig_time = 2,
        uses = 50,
        possible_items = {
        {itemid = 19488, count = 1, chance = 0.1},  -- 10% Bronze Chest 
        {itemid = 19489, count = 1, chance = 0.1},  -- 10% Silver Chest 
        {itemid = 19490, count = 1, chance = 0.05},  -- 5% Gold Chest 
        {itemid = 19491, count = 1, chance = 0.05},  -- 5% Platinum Chest 
        {itemid = 19492, count = 1, chance = 0.04},  -- 4% Diamond Chest 
        {itemid = 19500, count = 1, chance = 0.02},  -- 2% Emerald Chest 
        {itemid = 19501, count = 1, chance = 0.01}, -- 1% Ametrhyst Chest 
        {itemid = 19482, count = 1, chance = 0.1},  -- 10% Black pear
        {itemid = 19483, count = 1, chance = 0.08},  -- 8% Blue Pearl 
        {itemid = 19484, count = 1, chance = 0.07}, -- 7% Purple Pearl
        {itemid = 19485, count = 1, chance = 0.06},  -- 6% Red pearl
        {itemid = 19486, count = 1, chance = 0.05},  -- 5% Golden pearl
        {itemid = 19510, count = 1, chance = 0.1},  -- 10% Bronze Ore
        {itemid = 19517, count = 1, chance = 0.09},  -- 9% Silver Ore
        {itemid = 19518, count = 1, chance = 0.08},  -- 8% Gold Ore
        {itemid = 19519, count = 1, chance = 0.07},  -- 7% Platinum Ore
        {itemid = 16857, count = 2, chance = 0.3},  -- 30% Dragon Soul 
        {itemid = 12765, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12766, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12767, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12768, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12769, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12770, count = 1, chance = 0.007},  -- 0.7% Dragon Ball 
        {itemid = 12771, count = 1, chance = 0.007}  -- 0.7% Dragon Ball 
    }
    },
	[19513] = { -- Golden Shovel
    dig_time = 0.5,
    uses = math.huge,  -- Unlimited usage for one week
    expiration = os.time() + (7 * 24 * 60 * 60),  -- Expires in one week
    possible_items = {
        {itemid = 19488, count = 1, chance = 0.25},  -- 10% Bronze Chest 
        {itemid = 19489, count = 1, chance = 0.25},  -- 10% Silver Chest 
        {itemid = 19490, count = 1, chance = 0.15},  -- 15% Gold Chest 
        {itemid = 19491, count = 1, chance = 0.15},  -- 15% Platinum Chest 
        {itemid = 19492, count = 1, chance = 0.14},  -- 14% Diamond Chest 
        {itemid = 19500, count = 1, chance = 0.1}, -- 10% Emerald Chest 
        {itemid = 19501, count = 1, chance = 0.07},  -- 7% Ametrhyst Chest 
        {itemid = 19482, count = 1, chance = 0.25},  -- 25% Black pear
        {itemid = 19483, count = 1, chance = 0.18},  -- 18% Blue Pearl 
        {itemid = 19484, count = 1, chance = 0.17},  -- 17% Purple Pearl
        {itemid = 19485, count = 1, chance = 0.13},  -- 13% Red pearl
        {itemid = 19486, count = 1, chance = 0.1},  -- 1% Golden pearl
        {itemid = 19510, count = 1, chance = 0.25},  -- 25% Bronze Ore
        {itemid = 19517, count = 1, chance = 0.19},  -- 19% Silver Ore
        {itemid = 19518, count = 1, chance = 0.18}, -- 18% Gold Ore
        {itemid = 19519, count = 1, chance = 0.17},  -- 17% Platinum Ore
        {itemid = 16857, count = 2, chance = 0.5},  -- 50% Dragon Soul 
        {itemid = 12765, count = 1, chance = 0.01},  -- 1% Dragon Ball 
        {itemid = 12766, count = 1, chance = 0.01},  -- 1% Dragon Ball 
        {itemid = 12767, count = 1, chance = 0.01},  -- 1% Dragon Ball 
        {itemid = 12768, count = 1, chance = 0.01},  -- 1% Dragon Ball 
        {itemid = 12769, count = 1, chance = 0.01},  -- 1% Dragon Ball 
        {itemid = 12770, count = 1, chance = 0.01},  -- 1% Dragon Ball 
        {itemid = 12771, count = 1, chance = 0.01}  -- 1% Dragon Ball 
    }
}
}

local opCode = 56

local diggingInProgress = {}

local function removeMapMarks(holePosition)
    for pid, posTable in pairs(PLAYER_MARKS_CACHE) do
        local playerObject = Player(pid)
        if playerObject then
            if table.contains(posTable, holePosition) then
                playerObject:sendExtendedOpcode(opCode, json.encode(holePosition))
                table.removeValue(posTable, holePosition)
            end
        else
            PLAYER_MARKS_CACHE[pid] = nil
        end
    end
end

function createHole(position)
    local tile = Tile(position)
    if tile then
        local ground = tile:getGround()
        if ground then
            local groundId = ground:getId()
            if groundId == 9043 then
                Game.createItem(103, 1, position) -- Create a hole (ID 103) in the ground
            elseif groundId == 9044 then
                Game.createItem(104, 1, position) -- Create a hole (ID 104) in the ground
            elseif groundId == 9045 then
                Game.createItem(105, 1, position) -- Create a hole (ID 105) in the ground
            end
        end
    end
end

function repeatEffect(position, effect, times)
    if times > 0 then
        position:sendMagicEffect(effect)
        addEvent(repeatEffect, 1000, position, effect, times - 1)
    end
end

function onUse(player, item, fromPosition, target, toPosition, isHotkey)
    -- Check if the player is already digging
    if diggingInProgress[player:getGuid()] then
        player:sendTextMessage(MESSAGE_EVENT_ADVANCE, "You are already digging. Please wait until it's finished.")
        return false
    end

    local shovel = shovels[item:getId()]
    if not shovel then
        player:sendTextMessage(MESSAGE_EVENT_ADVANCE, "You need to use a shovel to dig here.")
        return false
    end

    if target.actionid ~= 9000 then
        player:sendTextMessage(MESSAGE_EVENT_ADVANCE, "You cannot dig here.")
        return false
    end

    -- Check if the shovel is the Golden Shovel and if it has expired
    if item:getId() == 38864 then
        local expiryTime = shovel.expiration
        if os.time() > expiryTime then
            player:sendTextMessage(MESSAGE_EVENT_ADVANCE, "Your golden shovel has expired.")
            print("Player " .. player:getName() .. " tried to use an expired golden shovel.")
            item:remove(1)
            return false
        end
    end

    local usesLeft = item:getCustomAttribute("uses") or shovel.uses
    if usesLeft <= 0 then
        player:sendTextMessage(MESSAGE_EVENT_ADVANCE, "Your shovel is broken.")
        item:remove(1)
        return false
    else
        player:sendExtendedOpcode(55, shovel.dig_time)
    end

    local targetPos = toPosition or target:getPosition()
    player:setMovementBlocked(true)

    -- Repeat the effect CONST_ME_HITAREA during the digging time
    repeatEffect(targetPos, 937, shovel.dig_time)

    addEvent(function()
    targetPos:sendMagicEffect(938)

        usesLeft = usesLeft - 1
        if usesLeft <= 0 then
            player:sendTextMessage(MESSAGE_INFO_DESCR, "Your shovel broke.")
            item:remove(1)
            createHole(target:getPosition()) -- Create a hole in the ground when the shovel breaks
        else
            -- Determine if an item is found during digging
            local foundItem = false
            for _, possible_item in ipairs(shovel.possible_items) do
                if math.random() <= possible_item.chance then
                    player:addItem(possible_item.itemid, possible_item.count)
                    player:sendTextMessage(MESSAGE_EVENT_ADVANCE, "You found an item while digging!")
                    foundItem = true
                    break
                end
            end
            if not foundItem then
                player:sendTextMessage(MESSAGE_EVENT_ADVANCE, "You dug but found nothing.")
            end

            -- Update usesLeft if the shovel has limited uses
            if shovel.uses ~= math.huge then
                item:setCustomAttribute("uses", usesLeft)
            end
        end

        player:setMovementBlocked(false)
        target:remove(1)
        removeMapMarks(toPosition)

        diggingInProgress[player:getGuid()] = nil
    end, shovel.dig_time * 1000)

    diggingInProgress[player:getGuid()] = true
    return true
end